



var lingKeyword1=[
    {"title":"1du [excl]","id":"1"},
    {"title":"1du [excl] indep pron","id":"1"},
    {"title":"1du [excl] possess pron","id":"1"},
    {"title":"1du [excl] / 2sg","id":"1"},
    {"title":"1du [excl] / 3sg","id":"1"},
    {"title":"1du [excl] / 2du","id":"1"},
    {"title":"1du [excl] / 2pl","id":"1"},
    {"title":"1du [excl] / 3du","id":"1"},
    {"title":"1du [excl] / 3pl","id":"1"},
    {"title":"1du [incl]","id":"1"},
    {"title":"1du [incl] indep pron","id":"1"},
    {"title":"1du [incl] possess pron","id":"1"},
    {"title":"1du [incl] / 3du","id":"1"},
    {"title":"1du [incl] / 3pl","id":"1"},
    {"title":"1du [incl] / 3sg","id":"1"},
    {"title":"1pl [excl]","id":"1"},
    {"title":"1pl [excl] indep pron","id":"1"},
    {"title":"1pl [excl] possess pron","id":"1"},
    {"title":"1pl [excl] / 2sg","id":"1"},
    {"title":"1pl [excl] / 3sg","id":"1"},
    {"title":"1pl [excl] / 2du","id":"1"},
    {"title":"1pl [excl] / 2pl","id":"1"},
    {"title":"1pl [excl] / 3du","id":"1"},
    {"title":"1pl [excl] / 3pl","id":"1"},
    {"title":"1pl [incl] ","id":"1"},
    {"title":"1pl [incl] indep pron","id":"1"},
    {"title":"1pl [incl] possess","id":"1"},
    {"title":"1pl [incl] / 3du","id":"1"},
    {"title":"1pl [incl] / 3pl","id":"1"},
    {"title":"1pl [incl] / 3sg","id":"1"},
    {"title":"1sg","id":"1"},
    {"title":"1sg indep pron","id":"1"},
    {"title":"1sg possess pron","id":"1"},
    {"title":"1sg / 2sg","id":"1"},
    {"title":"1sg / 3sg","id":"1"},
    {"title":"1sg / 2du","id":"1"},
    {"title":"1sg / 2pl","id":"1"},
    {"title":"1sg / 3du","id":"1"},
    {"title":"1sg / 3pl","id":"1"},
    {"title":"1trial ","id":"1"},
    {"title":"1trial indep pron","id":"1"},
    {"title":"1trial possess pron","id":"1"},
    {"title":"1trial / 3sg","id":"1"},
    {"title":"1trial / 3du","id":"1"},
    {"title":"1trial / 3pl","id":"1"},
    {"title":"2du","id":"1"},
    {"title":"2du indep pron","id":"1"},
    {"title":"2du possess pron","id":"1"},
    {"title":"2du / 1du [excl]","id":"1"},
    {"title":"2du / 1pl [excl]","id":"1"},
    {"title":"2du / 1sg","id":"1"},
    {"title":"2du / 3sg","id":"1"},
    {"title":"2du / 3du","id":"1"},
    {"title":"2du / 3pl","id":"1"},
    {"title":"2pl","id":"1"},
    {"title":"2pl indep pron","id":"1"},
    {"title":"2pl possess pron","id":"1"},
    {"title":"2pl / 1du [excl]","id":"1"},
    {"title":"2pl / 1pl [excl]","id":"1"},
    {"title":"2pl / 1sg","id":"1"},
    {"title":"2pl / 3sg","id":"1"},
    {"title":"2pl / 3du","id":"1"},
    {"title":"2pl / 3pl ","id":"1"},
    {"title":"2sg","id":"1"},
    {"title":"2sg indep pron","id":"1"},
    {"title":"2sg possess pron","id":"1"},
    {"title":"2sg / 1sg","id":"1"},
    {"title":"2sg / 3sg","id":"1"},
    {"title":"2sg / 3du","id":"1"},
    {"title":"2sg / 3pl","id":"1"},
    {"title":"2sg / 1du [excl]","id":"1"},
    {"title":"2sg / 1pl [excl]","id":"1"},
    {"title":"3du","id":"1"},
    {"title":"3du demonstrative pron (fem)","id":"1"},
    {"title":"3du demonstrative pron (masc)","id":"1"},
    {"title":"3du possess pron (fem)","id":"1"},
    {"title":"3du possess pron (masc)","id":"1"},
    {"title":"3du / 1sg","id":"1"},
    {"title":"3du / 1du [excl]","id":"1"},
    {"title":"3du / 1pl [excl]","id":"1"},
    {"title":"3du / 1du [incl]","id":"1"},
    {"title":"3du / 1pl [incl]","id":"1"},
    {"title":"3du / 1trial","id":"1"},
    {"title":"3du / 2sg","id":"1"},
    {"title":"3du / 2du","id":"1"},
    {"title":"3du / 2pl","id":"1"},
    {"title":"3du / 3sg","id":"1"},
    {"title":"3du / 3pl","id":"1"},
    {"title":"3pl","id":"1"},
    {"title":"3pl demonstrative pron (fem)","id":"1"},
    {"title":"3pl demonstrative pron (masc)","id":"1"},
    {"title":"3pl possess pron (fem)","id":"1"},
    {"title":"3pl possess pron (masc)","id":"1"},
    {"title":"3pl / 1sg","id":"1"},
    {"title":"3pl / 1du [excl]","id":"1"},
    {"title":"3pl / 1pl [excl]","id":"1"},
    {"title":"3pl / 1du [incl]","id":"1"},
    {"title":"3pl / 1pl [incl]","id":"1"},
    {"title":"3pl / 1trial","id":"1"},
    {"title":"3pl / 2sg","id":"1"},
    {"title":"3pl / 2du","id":"1"},
    {"title":"3pl / 2pl","id":"1"},
    {"title":"3pl / 3du","id":"1"},
    {"title":"3pl / 3sg","id":"1"},
    {"title":"3sg","id":"1"},
    {"title":"3sg demonstrative pron (fem)","id":"1"},
    {"title":"3sg demonstrative pron (masc)","id":"1"},
    {"title":"3sg possess pron (fem)","id":"1"},
    {"title":"3sg possess pron (masc)","id":"1"},
    {"title":"3sg / 1sg","id":"1"},
    {"title":"3sg / 1du [excl]","id":"1"},
    {"title":"3sg / 1pl [excl]","id":"1"},
    {"title":"3sg / 1du [incl]","id":"1"},
    {"title":"3sg / 1pl [incl]","id":"1"},
    {"title":"3sg / 1trial","id":"1"},
    {"title":"3sg / 2sg","id":"1"},
    {"title":"3sg / 2du","id":"1"},
    {"title":"3sg / 2pl","id":"1"},
    {"title":"3sg / 3du","id":"1"},
    {"title":"3sg / 3pl","id":"1"}
];

var lingKeyword2=[
    {"title":"Causative","id":"1"},
    {"title":"Copula","id":"1"},
    {"title":"Future","id":"1"},
    {"title":"Future tense","id":"1"},
    {"title":"Imperative","id":"1"},
    {"title":"Imperfect tense","id":"1"},
    {"title":"Habitual","id":"1"},
    {"title":"Incohative","id":"1"},
    {"title":"Intransitive","id":"1"},
    {"title":"Irrealis","id":"1"},
    {"title":"Medio-passive","id":"1"},
    {"title":"Negation","id":"1"},
    {"title":"Past","id":"1"},
    {"title":"Past continuous","id":"1"},
    {"title":"Past tense","id":"1"},
    {"title":"Present","id":"1"},
    {"title":"Present tense","id":"1"},
    {"title":"Reflexive","id":"1"},
    {"title":"Transitive verb","id":"1"},
    {"title":"Verb","id":"1"},
    {"title":"Verb ‘have’","id":"1"}
];

var lingKeyword3=[
    {"title":"Accusative ","id":"1"},
    {"title":"Ablative","id":"1"},
    {"title":"Allative","id":"1"},
    {"title":"Absolutive","id":"1"},
    {"title":"Commitative","id":"1"},
    {"title":"Dative","id":"1"},
    {"title":"Dual","id":"1"},
    {"title":"Ergative","id":"1"},
    {"title":"Fem","id":"1"},
    {"title":"Fem du","id":"1"},
    {"title":"Fem pl","id":"1"},
    {"title":"Fem sg","id":"1"},
    {"title":"Indirect object","id":"1"},
    {"title":"Instrumental","id":"1"},
    {"title":"Intransitive subject","id":"1"},
    {"title":"Locative","id":"1"},
    {"title":"Masc","id":"1"},
    {"title":"Masc du","id":"1"},
    {"title":"Masc pl","id":"1"},
    {"title":"Masc sg","id":"1"},
    {"title":"Nominative","id":"1"},
    {"title":"Neuter du","id":"1"},
    {"title":"Neuter pl","id":"1"},
    {"title":"Neuter sg","id":"1"},
    {"title":"Object","id":"1"},
    {"title":"Privative","id":"1"},
    {"title":"Possessive","id":"1"},
    {"title":"Subject","id":"1"},
    {"title":"Transitive subject","id":"1"}
];

var lingKeyword4=[
    {"title":"Adjective","id":"1"},
    {"title":"Adverb","id":"1"},
    {"title":"Agreement","id":"1"},
    {"title":"Allomorph","id":"1"},
    {"title":"Article","id":"1"},
    {"title":"Assimilation","id":"1"},
    {"title":"Conjunction","id":"1"},
    {"title":"Direction","id":"1"},
    {"title":"Ellipsis","id":"1"},
    {"title":"Emphasis","id":"1"},
    {"title":"Focus","id":"1"},
    {"title":"Greeting","id":"1"},
    {"title":"Interjection","id":"1"},
    {"title":"Interrogative","id":"1"},
    {"title":"Numeral","id":"1"},
    {"title":"Onomatopoeia","id":"1"},
    {"title":"Phonotactics","id":"1"},
    {"title":"Question","id":"1"},
    {"title":"Reduplication","id":"1"},
    {"title":"Subordinate clause","id":"1"},
    {"title":"Temporal","id":"1"}
];



var classes=[{"title":"Phrase","id":"2"},{"title":"Word","id":"3"}];
//var speakers=[{"title":"Sheila Conway","id":"2"},{"title":"Amy Dirn.gayg","id":"1"},{"title":"Josie Lardy","id":"3"},{"title":"Jessie Roberts","id":"4"}];

var language1Cap = language1.toLowerCase().replace(/\b[a-z]/g, function(letter) { return letter.toUpperCase();}); //capitalises first letter of each word in string
var language2Cap = language2.toLowerCase().replace(/\b[a-z]/g, function(letter) { return letter.toUpperCase();}); //capitalises first letter of each word in string

var conversations;



//var langFunctionSelectStr='<option value="0">Select a language function</option>';
//for (var lf=0; lf<langFunction.length; lf++){langFunctionSelectStr+='<option value="'+langFunction[lf].title+'">'+langFunction[lf].title+'</option>';}

var classSelectStr='<option value="0">Select an option</option>';
for (var c=0; c<classes.length; c++){	classSelectStr+='<option value="'+classes[c].title+'">'+classes[c].title+'</option>';}

//var speakerSelectStr='<option value="0">Select a speaker</option>';
//for (var s=0; s<speakers.length; s++){	speakerSelectStr+='<option value="'+speakers[s].title+'">'+speakers[s].title+'</option>';}

//Linguistic keyword dropdowns
var ling1SelectStr='<option value="0">PRONOUN</option>';
for (var l1=0; l1<lingKeyword1.length; l1++){ling1SelectStr+='<option value="'+lingKeyword1[l1].title+'">'+lingKeyword1[l1].title+'</option>';}
var ling2SelectStr='<option value="0">VERBAL</option>';
for (var l2=0; l2<lingKeyword2.length; l2++){ling2SelectStr+='<option value="'+lingKeyword2[l2].title+'">'+lingKeyword2[l2].title+'</option>';}
var ling3SelectStr='<option value="0">NOMINAL</option>';
for (var l3=0; l3<lingKeyword3.length; l3++){ling3SelectStr+='<option value="'+lingKeyword3[l3].title+'">'+lingKeyword3[l3].title+'</option>';}
var ling4SelectStr='<option value="0">OTHER</option>';
for (var l4=0; l4<lingKeyword4.length; l4++){ling4SelectStr+='<option value="'+lingKeyword4[l4].title+'">'+lingKeyword4[l4].title+'</option>';}

//full string version for mangarrayi app (backwards compatibility) and filter menu in index page
var lingSelectStr='<option value="0">Select an option</option>';
lingSelectStr+='<option value="">None</option>';
lingSelectStr+='<option value="0">==========</option>'+ ling1SelectStr;
lingSelectStr+='<option value="0">==========</option>'+ ling2SelectStr;
lingSelectStr+='<option value="0">==========</option>'+ ling3SelectStr;
lingSelectStr+='<option value="0">==========</option>'+ ling4SelectStr;

var  colour1Applier; var  colour2Applier; var  colour3Applier; var  colour4Applier; var  colour5Applier; var  colour6Applier; var  colour7Applier; var  colour8Applier; var  colour9Applier; var  colour10Applier; var  colour11Applier; var  colour12Applier; var  colour13Applier; var  colour14Applier; var  colour15Applier;
function togglecolour1() { colour1Applier.toggleSelection(); }
function togglecolour2() { colour2Applier.toggleSelection(); }
function togglecolour3() { removeGlossGroup2(); colour3Applier.toggleSelection(); }
function togglecolour4() { removeGlossGroup2(); colour4Applier.toggleSelection(); }
function togglecolour5() { removeGlossGroup2(); colour5Applier.toggleSelection(); }
function togglecolour6() { removeGlossGroup2(); colour6Applier.toggleSelection(); }
function togglecolour7() { removeGlossGroup2(); colour7Applier.toggleSelection(); }
function togglecolour8() { removeGlossGroup2(); colour8Applier.toggleSelection(); }
function togglecolour9() { removeGlossGroup2(); colour9Applier.toggleSelection(); }
function togglecolour10() { removeGlossGroup2(); colour10Applier.toggleSelection(); }
function togglecolour11() { removeGlossGroup2(); colour11Applier.toggleSelection(); }
function togglecolour12() { removeGlossGroup2(); colour12Applier.toggleSelection(); }
function togglecolour13() { removeGlossGroup2(); colour13Applier.toggleSelection(); }
function togglecolour14() { removeGlossGroup2(); colour14Applier.toggleSelection(); }
function togglecolour15() { removeGlossGroup2(); colour15Applier.toggleSelection(); }
function removeColours() { removeGlossGroup1(); removeGlossGroup2(); }

function removeGlossGroup1() { //bold and italic
  show("remove gloss group 1");
  colour1Applier.undoToSelection();
  colour2Applier.undoToSelection();
}
function removeGlossGroup2() {  //colours
  colour3Applier.undoToSelection();
  colour4Applier.undoToSelection();
  colour5Applier.undoToSelection();
  colour6Applier.undoToSelection();
  colour7Applier.undoToSelection();
  colour8Applier.undoToSelection();
  colour9Applier.undoToSelection();
  colour10Applier.undoToSelection();
  colour11Applier.undoToSelection();
  colour12Applier.undoToSelection();
  colour13Applier.undoToSelection();
  colour14Applier.undoToSelection();
  colour15Applier.undoToSelection();
}

//var initialText="";
//var selectedText="";
var selectedArea="";
var glossGroup1=0;
var glossGroup2=0;
var mode="";
var filters;
var characterLimit=500;
var paintingMode=true;
var oldValue="";

$(document).ready(function(){

    //populate language titles
    $(".language1").html(language1Cap); if (language1header!==""){$(".language1").html(language1header);}
    $(".language2").html(language2Cap);
    $("title").html(language1Cap+" Record and Write");

    $("#topicSelect").val($("#topicSelect").data("selected"));
    $("#additionaltopic1Select").val($("#additionaltopic1Select").data("selected"));
    $("#additionaltopic2Select").val($("#additionaltopic2Select").data("selected"));
    $("#functionSelect").val($("#functionSelect").data("selected"));
    $("#classSelect").html(classSelectStr).val($("#classSelect").data("selected"));
    $("#speakerSelect").val($("#speakerSelect").data("selected"));

    $("#ling1Select").html(ling1SelectStr).val($("#ling1Select").data("selected"));
    $("#ling2Select").html(ling2SelectStr).val($("#ling2Select").data("selected"));
    $("#ling3Select").html(ling3SelectStr).val($("#ling3Select").data("selected"));
    $("#ling4Select").html(ling4SelectStr).val($("#ling4Select").data("selected"));


   $(".glossCircle").click(function(e){ setGlossCircle(e.target);  });
   $(".glossManage").click(function(){
     var field="glossing";
     var id=$("#container").data("id");
     var url="manage.php?id="+id;
     var URLsearch=$('.searchInput').val();
     var URLfilter; URLfilter=getQueryVariable("filter");
     var URLkeyword; URLkeyword=getQueryVariable("keyword");
     if (URLfilter){url+="&filter="+URLfilter;}
     if (URLkeyword){url+="&keyword="+URLkeyword;}
     if (URLsearch&&URLsearch!==""){url+="&search="+URLsearch;}
     url+="&item="+field;
     window.location.href=url;
   });

    $('.ta').bind("mouseup", function() { //on mouse up
        if (mode==="Quick" || $("body").attr("id")==="edit"){ //are they in quick editing mode or in the edit page? then set format selected text
            if($(this).hasClass("glossing") && getSelectedText()!==""){//only if the div is able to be glossed and there is selected text
                if (glossGroup1==0&&glossGroup2==0){ return false;} //no glossing colour has been selected - go no further
                if (glossGroup1!==0 && paintingMode===true){glossText(glossGroup1);} //if glossing group 1 (bold or italic) is on then gloss text with group 1
                if (glossGroup2!==0 && paintingMode===true){glossText(glossGroup2);} //if glossing group 2 (colours) is on then gloss text with group 2
            }
        }
    });

    //Every time they type into search box  it should show search results
    $('.searchInput').bind('keyup', function(e) {
      var code = e.keyCode || e.which;
      if(code === 13) { $('.searchInput').blur(); }//hide sot keyboard if they hit enter (mobile)
      var val=$(this).val(); $('.searchInput').val(val);
      showSearchResults(val);
    });
    $(".searchInput").blur(function() {writeCounters();	});

    $('.ta').keydown(function(){ //listener to check for character limit and change style of textarea to reflect
        if($(this).text().length>characterLimit){ $(this).css("background-color","#f1d8d8");   } else { $(this).css("background-color","inherit"); }
    });


    $(".ta").on("paste", function(e){//listener for when cutting and pasting into text area
        //show("pasting");
        //get the copied data from the clipboard and convert to plain text
        var pastedData = e.originalEvent.clipboardData.getData('text/html');
				show("pasted data "+pastedData);
				if (pastedData.indexOf("<")!==-1){//don't paste if it contains HTML content or formatting
					alert("Your copied text contains formatting that is not compatible with the glossing tool. \n\nIf you are using Google Chrome make sure you have enabled clipboard access (search the Chrome settings for \'Clipboard\'). \n\nIf you are using Firefox try copying unformatted text or using another browser such as Chrome.")
					e.preventDefault();
				}
        //if there's nothing in the text box then paste the text data
        //if($(this).html()===""){$(this).html(pastedData);}
        //prevent pasting the clipboard data to prevent rich text being pasted and messing up the glossing formatting

    });

    $( "select").change(function() {
        var id=$(this).data("id");
        if ($(this).attr("id")==="filter1"||$(this).attr("id")==="filter2"){return false;} //don't do anything for filter drop downs
        var value=$(this).val();
        var field=$(this).attr("id").substring(0, $(this).attr("id").indexOf("Select"));
        if (value==="M"){manageSelect(field); return false;} //manage-related dropdowns
        //save fields with mutiple selects
        if (field.indexOf("additionaltopic")!==-1){
            //save additional topics
            if (value==="0"){ //check they have selected a topic
                alert("Make sure you have selected a topic, not a heading. (Headings are written in capital letters).");
            } else {
                field="related"; //field name in database
                value=""; //reset value
                if ($("#additionaltopic1Select").val()!=="0"&&$("#additionaltopic1Select").val()!==""){value+=$("#additionaltopic1Select").val();} //add first dropdown value to value
                if ($("#additionaltopic2Select").val()!=="0"&&$("#additionaltopic2Select").val()!==""){value+=","+$("#additionaltopic2Select").val();} //add second dropdown value to value
                saveField(id,field,value); //save to DB
            }
        } else if (field.indexOf("ling")!==-1){
            //save linguistic keywords
            if (value==="0"){ //check they have selected a keyword
                alert("Make sure you have selected a keyword, not a category. (Categories are written in capital letters).");
            } else {
                field="keywordling"; //field name in database
                value=""; //reset value
                if ($("#ling1Select").val()!=="0"&&$("#ling1Select").val()!==""){value+=$("#ling1Select").val();} //add first dropdown value to value
                if ($("#ling2Select").val()!=="0"&&$("#ling2Select").val()!==""){value+=","+$("#ling2Select").val();} //add 2nd dropdown value to value
                if ($("#ling3Select").val()!=="0"&&$("#ling3Select").val()!==""){value+=","+$("#ling3Select").val();} //add 3rd dropdown value to value
                if ($("#ling4Select").val()!=="0"&&$("#ling4Select").val()!==""){value+=","+$("#ling4Select").val();} //add 4th dropdown value to value
                saveField(id,field,value); //save to DB
            }
        } else {
            //all other selects
            saveField(id,field,value);
        }
    });

    //convert any glossing-enabled input containing old mark up to HTML glossing
    $("div.glossing").each(function() {    $(this).html(setGlossing($(this).html()));   });

    if($("body").attr("id")==="entries"){ //for index page
        //set scroll position in session storage
        $(window).scroll(function () {sessionStorage.scrollPos = $(window).scrollTop();});
        //get scroll position in session storage
        $(window).scrollTop(sessionStorage.scrollPos || 0);

        getFilters(); //load filters from database ready for filter mode
        var URLsearch; URLsearch=getQueryVariable("search");
        if (URLsearch){//if they are returning and have previously loaded a search
            $(".searchInput").val(URLsearch);//polulate the search input
            showSearchResults(URLsearch);//display search results
        }
        writeCounters(); //write each table row

        var URLfilter; URLfilter=getQueryVariable("filter");
        //onboarding
        if($("#entriesTable tr").length===0 && !URLfilter){
        //if(language1==="ktunaxa"){
          //console.log(topics.length);
          //no entries - show onboarding
          onboard(1);
          chooseTemplate(1);
        } else {
          if (!localStorage.getItem('OPALtooltip')){$(".tooltiptext1").css("display","block"); localStorage.setItem('OPALtooltip',true)} //show tooltip
        }
      }

    //for manage page
    if($("body").attr("id")==="manage"){   writeCounters();}

    //auto save flag once we have opened the entry to edit it
    if($("body").attr("id")==="edit"){
		var i=$("#container").data("id");
		saveFlag(i);
		var val1=stripHTML($("#keywordlanguage").html());saveField(i,"keyword",val1);//save keywords (unglossed) becuase these are autopoluated on load
		saveField(i,"keywordtranslation",$("#keywordtranslation").html());//save language 2 keywords becuase these are autopoluated on load
	}

  if($("body").attr("id")==="entries"||$("body").attr("id")==="edit"){ //for glossing pages
    rangy.init(); //range and selection library - https://github.com/timdown/rangy
    var classApplierModule = rangy.modules.ClassApplier;
    colour1Applier = rangy.createClassApplier("colour1", {  tagNames: ["span", "img"]});
    colour2Applier = rangy.createClassApplier("colour2", {  tagNames: ["span", "img"]});
    colour3Applier = rangy.createClassApplier("colour3", {  tagNames: ["span", "img"]});
    colour4Applier = rangy.createClassApplier("colour4", {  tagNames: ["span", "img"]});
    colour5Applier = rangy.createClassApplier("colour5", {  tagNames: ["span", "img"]});
    colour6Applier = rangy.createClassApplier("colour6", {  tagNames: ["span", "img"]});
    colour7Applier = rangy.createClassApplier("colour7", {  tagNames: ["span", "img"]});
    colour8Applier = rangy.createClassApplier("colour8", {  tagNames: ["span", "img"]});
    colour9Applier = rangy.createClassApplier("colour9", {  tagNames: ["span", "img"]});
    colour10Applier = rangy.createClassApplier("colour10", {  tagNames: ["span", "img"]});
    colour11Applier = rangy.createClassApplier("colour11", {  tagNames: ["span", "img"]});
    colour12Applier = rangy.createClassApplier("colour12", {  tagNames: ["span", "img"]});
    colour13Applier = rangy.createClassApplier("colour13", {  tagNames: ["span", "img"]});
    colour14Applier = rangy.createClassApplier("colour14", {  tagNames: ["span", "img"]});
    colour15Applier = rangy.createClassApplier("colour15", {  tagNames: ["span", "img"]});
  }

  if($("body").attr("id")==="conversations"){ //for conversations page
    getConversations();
    var conversationId=$("#container").data("id");
    if(conversationId!==0){$("#entry1").val(conversationId);}//prepopulate first dropdown with phrase id
  }

	$("#addConversation").click(function(){
		var testEntry=$("#entry1").val();
        if(testEntry==="0"){alert("Please enter at least one item"); return;}
        $.get(apiPath+"set-conversation.php?table="+language1+"&var1="+$("#entry1").val()+"&var2="+$("#entry2").val()+"&var3="+$("#entry3").val()+"&var4="+$("#entry4").val()+"&var5="+$("#entry5").val()+"&var6="+$("#entry6").val(), function() {})
        .done(function() {getConversations();})
        .fail(function() { });
	});

  $("#logout").click(function(){
    $.get(apiPath+"logout.php", function() {})
    .done(function() {window.location.href=apiPath;})
    .fail(function() {alert("Log out failed. Try closing and reopening your browser instead.") });
  });

});//end document ready

function playOnboarding(){
  onboard(1);
  localStorage.removeItem('OPALtooltip');
}


function textAreaFocus(e){
    //show($(e).data("id"));
    //initialText=$(e).html();
    selectedArea=$(e).attr("id");
    oldValue=$(e).html();
    var table="entriesTable"; if($("body").attr("id")==="manage"){table="manageTable";}
    if($("body").attr("id")==="entries"||$("body").attr("id")==="manage"){//add new blank row to the entries table if they are using the last row
        //show("textarea data id "+$(e).data("id")+ " last row "+$('#entriesTable tr:last').data("id"));
        if ($(e).data("id")===$('#'+table+' tr:last').data("id")) {
            show("Adding empty row");
            addRow();
        }
    }
	cleanClipboard();
}

function cleanClipboard(){
	//For page scripts, the Permissions API's "clipboard-write" permission is needed. You can check for that permission using navigator.permissions.query():
	//navigator.permissions.query({name: "clipboard-write"}).then(result => {
	//if (result.state == "granted" || result.state == "prompt") {
		//retrieves the textual contents of the clipboard
	try{
		navigator.clipboard.readText().then(
		//writes to the clipboard
		clipText => {
			var cleanText=stripHTML(clipText);
			//show('cleaned up text '+cleanText);
			navigator.clipboard.writeText(cleanText).then(function() {
			/* clipboard successfully set */
			}, function() {
				/* clipboard write failed */
			})
		}
	);
	}
	catch(err) {show(err.message);}

	//}
	//});
}

function textAreaBlur(e){
    //show("new text "+$(e).html());
   // if ($(e).html()!==initialText){ //only save it if it's different to the intiial text
    var id=$(e).data("id");
    var field=$(e).data("field");
    var value=cleanUp($(e).html());
    if ($(e).hasClass("glossing")===false){value = stripHTML(value); $(e).html(value);} //strip any HTML tags if it isn't a glossed text area
    if ($(e).hasClass("hex")===true){  $(e).closest('tr').css("background-color","#"+$(e).html());  } //apply new hex code to table row
    //value=encodeURIComponent(value);
    saveField(id,field,value);
    
    if (language1==="sandpit"||language1==="ktunaxa"||language1==="german"||language1==="chinese"){
      //copy English (language 2) to explanation if explanation is empty
      if ($(e).data("field")==='translation' && $("#explanation"+$(e).data("id")).html()===""){
        $("#explanation"+$(e).data("id")).html($(e).html());
        saveField(id,"explanation",$(e).html());//auto save explanation to DB after pre-populating it
      }
    }
}

function getSelectedText() {
    var html = "";
    if (typeof window.getSelection != "undefined") {
        var sel = window.getSelection();
        if (sel.rangeCount) {
            var container = document.createElement("div");
            for (var i = 0, len = sel.rangeCount; i < len; ++i) {
                container.appendChild(sel.getRangeAt(i).cloneContents());
            }
            html = container.innerHTML;
        }
    } else if (typeof document.selection != "undefined") {
        if (document.selection.type == "Text") {
            html = document.selection.createRange().htmlText;
        }
    }
    return html;
}


function setSelectedText(){//format selected text
    /*
    //show("selected Area "+selectedArea+" to group1 "+glossGroup1+" and group2 "+glossGroup2);
    if (glossGroup1==0&&glossGroup2==0){ return false;} //no glossing colour has been selected - go no further
    var originalText=$("#"+selectedArea).html();
    show("original text: "+originalText);

    show("original text selected: "+selectedText);

    var selectedTextClean=stripHTML(selectedText); //<span class="colour7">his</span> nose -> his nose
    show("clean selected text: "+selectedTextClean);

    var originalTextClean=stripHTML(originalText); //<span class="colour7">his</span> nose -> his nose
    show("clean original text: "+originalTextClean);

    //work out selection start and end (cannot use active element selectionStart as this is only for textareas)
    var el = document.getElementById(selectedArea);
    var selectionEnd=getCaretCharacterOffsetWithin(el); //work out where the selected area ends
    //add length of tags to selectionEnd

    var selectionStart=selectionEnd-selectedTextClean.length; if(selectionStart<0){selectionStart=0;}
    show("Selection start: " + selectionStart+" end: " + selectionEnd);

    //split up original text and store in variables
    var beforeText=originalTextClean.substr(0,selectionStart); //any text before selected text
    var afterText=originalTextClean.substr(selectionEnd); //any text after selected text

    show("original before text: "+beforeText);
    show("original text selected: "+selectedText);
    show("original after text: "+afterText);

    //remove any </span> from aftertext that hasn't got an opening tag e.g. blah </span> blah blah <span>blah</span>
    if (afterText.indexOf("</span>")!==-1){
        //var closed=true; var checkLength=3;
        //for (var i = 0; i <afterText.length-checkLength; i++){
            //var checkChar=afterText.substr(i,checkLength);
            //show(checkChar);
       // }


        //if($.trim(originalTextArray[2]).substr(0,7)==="</span>"){originalTextArray[1]=originalTextArray[1].substr(7);}
    }
     //show("original text end without span ends: "+originalTextArray[1]);

    //show("selected text: "+selectedText);


    var formattedStr=selectedTextClean;
    var colourClass="";//default is no format
    //a glossing colour has been selected
    if (glossGroup1!==0){colourClass+="colour"+glossGroup1+" ";}//add colour for glossing group 1
    if (glossGroup2!==0){colourClass+="colour"+glossGroup2+" ";}//add colour for glossing group 2
    formattedStr='<span class="'+$.trim(colourClass)+'">'+selectedTextClean+'</span>'; //new text with formatting
    show("formatted text "+formattedStr);
    var result = beforeText+formattedStr; //put start text back on
    if (afterText!==""){result+=afterText;}//put end text back on if relevant
     //$("#"+selectedArea).html(result); //populate textarea with new text
    show("result: "+result);
    */
}

//span class="colour9">doer</span>(boy one) galah <span class="colour2">Na</span> <span class="colour1">live</span> high up tree <span class="colour10">in</span>
//copied from https://stackoverflow.com/questions/4811822/get-a-ranges-start-and-end-offsets-relative-to-its-parent-container
function getCaretCharacterOffsetWithin(element) {
    var caretOffset = 0;
    var doc = element.ownerDocument || element.document;
    var win = doc.defaultView || doc.parentWindow;
    var sel;
    if (typeof win.getSelection != "undefined") {
        sel = win.getSelection();
        if (sel.rangeCount > 0) {
            var range = win.getSelection().getRangeAt(0);
            var preCaretRange = range.cloneRange();
            preCaretRange.selectNodeContents(element);
            preCaretRange.setEnd(range.endContainer, range.endOffset);
            caretOffset = preCaretRange.toString().length;
        }
    } else if ( (sel = doc.selection) && sel.type != "Control") {
        var textRange = sel.createRange();
        var preCaretTextRange = doc.body.createTextRange();
        preCaretTextRange.moveToElementText(element);
        preCaretTextRange.setEndPoint("EndToEnd", textRange);
        caretOffset = preCaretTextRange.text.length;
    }
    return caretOffset;
}


function stripHTML(html){//strip HTML tags from string
    var temporalDivElement = document.createElement("div");
    temporalDivElement.innerHTML = html;
    return temporalDivElement.textContent || temporalDivElement.innerText || "";
}

//====================================================================== FILTERS //

function setFilter(n){
    n=parseInt(n);
    var val=$("#filter"+n).val(); //show(val);
    //check they have selected a filter
    if (val==="0"){alert("Make sure you haven't selected a heading. (Headings are written in capital letters)."); return false;}
    hideSecondFilter();
    if (n===1){ //first level filter selected
        switch (val){
            case "0": break;
            //case "search": $("#filter2").css("display", "none"); break;
            case "flag": reloadPage(val); break;
            case "sort1": reloadPage(val); break;
            case "sort2": reloadPage(val); break;
            case "sort3": reloadPage(val); break;
            case "clear": reloadPage(); break;
            default: getSecondFilterValues(val);
        }
    } else {
        //second level filter selected
        switch (val){
            case "0": break;
            case "M": manageSelect("topic"); break;
            case "MS": manageSelect("speaker"); break;
            default: reloadPage($("#filter1").val(),val);
        }
    }
}

function getSecondFilterValues(filter,keyword){
    //this populates the 2nd filter dropdown according to what they have selected in the 1st filter dropdown
    //show("Filters "+filter+" Filters: "+JSON.stringify(filters));
    show("getSecondFilterValues for filter "+filter+" and keyword "+keyword);

    var filterArray=[]; //set up new array to store the values e.g. the different keywords
    for (var b=0; b<filters.length; b++){ //loop through the chunkbank database to get all the items for the selected filter e.g. all the english keywords
        if (filters[b][filter]==null){filters[b][filter]="";}//make sure we are not working with null values
        var filterString=filters[b][filter];
        if (filter==="topic"){
          if (filters[b]["related"]!=null){if (filterString!==""){filterString+=",";} filterString+=filters[b]["related"];}
        }
        var tempFilterArray = filterString.split(","); //split the keywords for the selected filter
        for (var c=0; c<tempFilterArray.length; c++){
            var newItem = tempFilterArray[c].replace(/-/g, '').trim();//replace dashes and extra space from filter item
            if (filter!=="speaker"){newItem=newItem.toLowerCase();}//change all filter items to lower case except speaker names
            if (filterArray.indexOf(newItem) === -1 && newItem!==""&& newItem!=="0"){filterArray.push(newItem);} //push filter items into an array and avoid duplicates
        }
    }
    //now sort filter item list into alphabetical order
    filterArray.sort();

    //create select for the second filter items
    var filterSelectStr='<option value="0">Select an option</option>';


    var classStr="";//to hold specific classes within select options

    if (filter==="class"){//if they have selected class from first filter dropdown list
      classes.forEach((item, i) => {  filterSelectStr+='<option value="'+item.title+'">'+item.title+'</option>';});

    } else if (filter==="function"){//if they have selected function from the first filter menu
      functions.forEach((item, i) => {
        if(item!==""&&item!=="0"&&item){
          //make bold if any phrase has been tagged with this function
          classStr="";  if(filterArray.indexOf(item.toLowerCase())!==-1){classStr=' class="selectBold"';}
          //write list of functions to second filter dropdown
          filterSelectStr+='<option value="'+item+'"'+classStr+'>'+item+'</option>';
        }
      });

    } else if (filter==="speaker"){//if they have selected speaker from the first filter menu
      filterSelectStr='<option value="0">Select a speaker</option>';
      filterSelectStr+='<option value="MS">Add a new speaker</option>';
      show(speakers);
      speakers.forEach((item, i) => {
        if(item!==""&&item!=="0"&&item){
          //make bold if any phrase has been tagged with this function
          classStr="";  if(filterArray.indexOf(item.toLowerCase())!==-1){classStr=' class="selectBold"';}
          //write list of speakers to second filter dropdown
          filterSelectStr+='<option value="'+item+'"'+classStr+'>'+item+'</option>';
        }
      });

    } else if (filter==="keywordling"){//if they have selected ling keyword from the first filter menu
      filterSelectStr=lingSelectStr;

    } else if (filter==="topic"){//if they have selected topics from the first filter menu
      filterSelectStr='<option value="0">Select a topic</option>';
      filterSelectStr+='<option value="M">Add your own topic</option>';
      topics.forEach((item, i) => {
      	filterSelectStr+='<option value="0">---------------</option>';
      	filterSelectStr+='<option value="0">'+item.title.toUpperCase()+'</option>';
        item.subtopics.forEach((item, i) => {
          //make bold if any phrase has been tagged with this topic
          if(item!==""&&item!=="0"&&item){
            classStr="";  if(filterArray.indexOf(item.toLowerCase())!==-1){classStr=' class="selectBold"';}
            filterSelectStr+='<option value="'+item+'"'+classStr+'>'+item+'</option>';
          }
        });
      });


    } else {
      //for keywords
      filterArray.forEach((item, i) => {filterSelectStr+='<option value="'+item+'">'+item+'</option>';});
      //if no keywords or speakers have been assigned yet
      if (filterArray.length===0){filterSelectStr='<option value="0">You need to add keywords to your phrases first</option>';}
    }

    $("#filter2").html(filterSelectStr).css("display", "inline");
    if(keyword){ $("#filter2").val(keyword);}
}

function hideSecondFilter(){
    //$("#filterSearch").css("display", "none");
     $("#filter2").html("").css("display", "none");
}

function getFilters(){
    $.getJSON(apiPath+"get-filters.php?table="+language1, function(data) {if (data!==0) {filters=data; }})
	.done(function() {
        $("#filter1").css("display","inline"); //show filter option once filters have loaded
        //if there's a keyword specified in the URL then populate the second filter dropdown with all the keywords for the specified filter
        var URLkeyword; URLkeyword=getQueryVariable("keyword");  if (URLkeyword){getSecondFilterValues(getQueryVariable("filter"),URLkeyword);}
    })
	.fail(function() {alert("Could not access the database to get the filters.");});
}

function reloadPage(filter,keyword){
    var url="index.php";
    if (filter){
        url+="?filter="+filter;
        if(keyword){ url+="&keyword="+keyword; }
    }
    window.location.href=url;
}

function getQueryVariable(variable){
       var query = window.location.search.substring(1);
       var vars = query.split("&");
       for (var i=0;i<vars.length;i++) {
               var pair = vars[i].split("=");
               if(pair[0] == variable){
                   var str=decodeURIComponent(pair[1]);
                   return str;
               }
       }
       return(false);
}


function showSearchResults(word){
   // var needle = word.replace(/-/g, '').trim().toLowerCase(); //remove dashes
    var needle = word.trim().toLowerCase();
    showModeView('Search');
    show("============SEARCH: "+needle);
    var hidden;
    $("#entriesTable tr").each(function(i,row) {
        var $row = $(row),
        $content = $row.find('.ta');
        hidden=true;
        $content.each(function () {
            var haystack=stripHTML($(this).html().toLowerCase());
            if(haystack.indexOf(needle)!==-1){
                hidden=false;
                return false;
            }
            //show($(this).attr("id")+" "+haystack+" needle "+needle+" "+hidden);
        });
        //show("ROW "+$(this).attr("id")+" "+hidden);
        if (hidden===true){$(this).css("display","none");} else{$(this).css("display","table-row");}
    });
}
function clearSearch(){
    $("#entriesTable tr").css("display","table-row");
    hideModeView();
    writeCounters();
    $(".searchInput").val('');
}

//====================================================================== ONBOARDING //

function onboard(num){
  $.fancybox.close();//close popup
  var id="popup_onboarding"+num;
  $.fancybox.open({src:'#'+id,type:'inline'});
}


function closeToolTip(num){
  var id="tooltiptext"+num;
  $("."+id).css("display","none");
}

function chooseTemplate(template){
  $(".templateButtons button").removeClass("selected");
  $("#template"+template).addClass("selected");
  console.log(apiPath+"set-template.php?template="+template);
  $.get(apiPath+"set-template.php?template="+template, function() {})
  .done(function(){$("#onboardFinish").css("display","block");  })
  .fail(function() { alert("We couldn't set up the template. Please contact Elearn Australia on 0424 045 479.");});
}

function onboardFinish(){
  //populate template1
  $.fancybox.close(); //close popup
  if (!localStorage.getItem('OPALtooltip')){$(".tooltiptext1").css("display","block"); localStorage.setItem('OPALtooltip',true)} //show tooltip
  //window.location.reload();
}
//====================================================================== MODES //

function show(msg){
    console.log(msg);
}

function showModeView(n){
  $("body, .containerHead, #modeButton"+n+", #modeButton"+n+" button, #modeButton"+n+" input").addClass("modeView");
  //$("..modeNavigation button").css("display", "none");
}
function hideModeView(){
  $("body, .containerHead, .modeButton, .modeButton button, .modeButton input").removeClass("modeView");
  //$(".modeNavigationButtons .modeButton .modeButtonItem button").css("display", "none");
}
function showQuick(){
  if (mode!=="Quick"){showMode("Quick");}
}

function showMode(n){
    resetMode();
    $("#modeButton"+n+" .modeButtonFull").css("display","inline");
    $("#modeButton"+n+"Close").css("display","inline");
    showModeView(n);
    mode=n;
    if (mode==="Quick"){
        $("#glossHelperArrow").css("display","block");
        $(".ta").attr("contenteditable","true");
        $(".saveButton, .addButton, .ta").removeClass("disabled");
        $(".ta").prop("placeholder","Type here");
    } else {
        //resetGlossCircles(3);//set default glossing circle
    }
}
function resetMode(){
    mode="";
    $(".ta").attr('contenteditable','false');
    $(".saveButton, .addButton, .ta").addClass("disabled");
    $('.modeButtonFull, .modeButtonClose, #glossHelper, #glossHelperArrow').css("display", "none");
    hideModeView();
}
function toggleGlossHelper(){
    if ($("#glossHelper").css("display")==="block"){
        $("#glossHelper").slideUp();
        $("#glossHelperArrow i").addClass("fa-chevron-down").removeClass("fa-chevron-up");
    } else {
        $("#glossHelper").slideDown();
        $("#glossHelperArrow i").addClass("fa-chevron-up").removeClass("fa-chevron-down");
    }
}

function toggleAdvancedTopics(){
    if ($(".advanced").css("display")==="block"){
        $(".advanced").slideUp();
        $(".showHideText").html("Show");
        $("#advancedTopicsArrow i").addClass("fa-chevron-down").removeClass("fa-chevron-up");
    } else {
        $(".advanced").slideDown();
        $(".showHideText").html("Hide");
        $("#advancedTopicsArrow i").addClass("fa-chevron-up").removeClass("fa-chevron-down");
    }
}

function setGlossCircle(e){
    var group=parseInt($(e).data("glossgroup")); //get group - either 1 (bold,italic) , 2 (colours)  or 3 (none)
    var id=parseInt($(e).data("glossid")); //get id of glossing 1-14 or 20 (none)

     if ($(e).hasClass("on")===false){ //set circle to on if it's off or there is any text selected
        resetGlossCircles(group); //deactivate glossing circles for selected group
        switch(group){ //set selected group id
            case 1: glossGroup1=id; break;
            case 2: glossGroup2=id;  break;
        }
        $(e).addClass("on"); //turn on selected circle
        show("SHOW group: "+group+" glossid: "+$(e).data("glossid")+" id "+id+" glossGroup1: "+glossGroup1+" glossGroup2: "+glossGroup2);
         if (getSelectedText()!=="" && $("#"+selectedArea).hasClass("glossing")){
            //colour any selected text that is within a 'glossing' text area
            glossText(id);
         }
    } else {
        //toggle circle off
        //turn off
        switch(group){ //set selected group id
            case 1: glossGroup1=0; break;
            case 2: glossGroup2=0;  break;
        }
        $(e).removeClass("on"); //turn off selected circle
        if (glossGroup1===0 && glossGroup2===0){$(".glossGroup3.glossCircle").addClass("on");} //turn on group 3 circle (none)
        show("HIDE group: "+group+" glossid: "+$(e).data("glossid")+" id "+id+" glossGroup1: "+glossGroup1+" glossGroup2: "+glossGroup2);
        if (getSelectedText()!=="" && $("#"+selectedArea).hasClass("glossing")){
           //colour any selected text that is within a 'glossing' text area
           glossText(id);
        }
    }


    //group: 2 glossid: 5 id 5 glossGroup1: 0 glossGroup2: 5
    //format text if there is anything selected
     //if(selectedText!==""){ setSelectedText(); }
}

function resetGlossCircles(group){
    if (parseInt(group)==3){
       $(".glossCircle").removeClass("on"); //if group = 3 (none) then turn off everything
        $(".glossGroup3.glossCircle").addClass("on"); //turn on group 3 circle (none)
        glossGroup1=0; glossGroup2=0;  //reset group ids if they have selected group 3 (none)
    } else {
         //only one circle per group 1 or 2  can be on
        $(".glossGroup"+group+".glossCircle").removeClass("on");
        //also turn off reset (group 3)
         $(".glossGroup3.glossCircle").removeClass("on");
    }
}

function glossText(id){
  console.log("glossText "+id);
    switch (id){
        case 1: togglecolour1(); break;
        case 2: togglecolour2(); break;
        case 3: togglecolour3(); break;
        case 4: togglecolour4(); break;
        case 5: togglecolour5(); break;
        case 6: togglecolour6(); break;
        case 7: togglecolour7(); break;
        case 8: togglecolour8(); break;
        case 9: togglecolour9(); break;
        case 10: togglecolour10(); break;
        case 11: togglecolour11(); break;
        case 12: togglecolour12(); break;
        case 13: togglecolour13(); break;
        case 14: togglecolour14(); break;
        case 15: togglecolour15(); break;
        case 20: removeColours(); break;
    }
}

function editConversations(id){
    var url="conversations.php?id="+id;
    var URLsearch=$('.searchInput').val();
    var URLfilter; URLfilter=getQueryVariable("filter");
    var URLkeyword; URLkeyword=getQueryVariable("keyword");
    if (URLfilter){url+="&filter="+URLfilter;}
    if (URLkeyword){url+="&keyword="+URLkeyword;}
    if (URLsearch!==""){url+="&search="+URLsearch;}
    window.location.href=url;
}

function viewShell(id,conv){
    var url=shellPath+"&id="+id+"&conv="+conv;
    window.open(url,"listenandtalk");
}

function editEntry(id){
    var url="edit.php?id="+id;
    var URLsearch=$('.searchInput').val();
    var URLfilter; URLfilter=getQueryVariable("filter");
    var URLkeyword; URLkeyword=getQueryVariable("keyword");
    if (URLfilter){url+="&filter="+URLfilter;}
    if (URLkeyword){url+="&keyword="+URLkeyword;}
    if (URLsearch!==""){url+="&search="+URLsearch;}
    window.location.href=url;
}

function deleteEntry(id){
  if($("#delete"+id).hasClass("disabled")){return;}
	var r = confirm("Are you really sure you want to delete this entry?");
	if (r !== true) {return false;} else{
		show("DELETING ENTRY "+id+" call "+apiPath+"deleteentry.php?id="+id);
		$.get(apiPath+"delete-entry.php?id="+id+"&table="+language1, function() {})
		.done(function(){
      $("#tableRow"+id).remove();
		})
		.fail(function() { alert("We couldn't entry from the database. Please contact Elearn Australia on 0424 045 479.");});
	}
}

function entryBack(){
    var url="index.php";
    var URLsearch; URLsearch=getQueryVariable("search");
    var URLfilter; URLfilter=getQueryVariable("filter");
    var URLkeyword; URLkeyword=getQueryVariable("keyword");
    if (URLfilter){
        url+="?filter="+URLfilter;
        if (URLkeyword){url+="&keyword="+URLkeyword;}
        if (URLsearch){url+="&search="+URLsearch;}
    } else if (URLsearch){
        url+="?search="+URLsearch;
    }
    window.location.href=url;
}

function manageSelect(field){ //from edit page select dropdowns
  var id=$("#container").data("id");
  var url="manage.php?id="+id;
  var URLsearch=$('.searchInput').val();
  var URLfilter; URLfilter=getQueryVariable("filter");
  var URLkeyword; URLkeyword=getQueryVariable("keyword");
  if (URLfilter){url+="&filter="+URLfilter;}
  if (URLkeyword){url+="&keyword="+URLkeyword;}
  if (URLsearch&&URLsearch!==""){url+="&search="+URLsearch;}
  url+="&item="+field;
  window.location.href=url;
}

function manageBack(){
    var id=$("#container").data("id");
    var url="edit.php?id="+id;

    var URLsearch; URLsearch=getQueryVariable("search");
    var URLfilter; URLfilter=getQueryVariable("filter");
    var URLkeyword; URLkeyword=getQueryVariable("keyword");
    var URLitem; URLitem=getQueryVariable("item");
    if (id==="undefined"){url="index.php?id=0";  }//if there is no id then just go back to index page
    if (URLitem==="heading"){url="manage.php?id="+id+"&item=topic";  }//if we're managing headings then go back to managing topics
    if (URLitem==="glossing"){url="index.php?id="+id;  }//if we're managing glossing then just go back to index page

    if (URLfilter){
        url+="&filter="+URLfilter;
        if (URLkeyword){url+="&keyword="+URLkeyword;}
        if (URLsearch){url+="&search="+URLsearch;}
    }
    if (URLsearch&&URLsearch!==""){url+="&search="+URLsearch;}
    window.location.href=url;
}

function conversationsBack(){
    var id=$("#container").data("id");
    var url="index.php?id="+id;
    var URLsearch; URLsearch=getQueryVariable("search");
    var URLfilter; URLfilter=getQueryVariable("filter");
    var URLkeyword; URLkeyword=getQueryVariable("keyword");
    var URLitem; URLitem=getQueryVariable("item");
    if (URLfilter){
        url+="&filter="+URLfilter;
        if (URLkeyword){url+="&keyword="+URLkeyword;}
        if (URLsearch){url+="&search="+URLsearch;}
    }
    if (URLsearch&&URLsearch!==""){url+="&search="+URLsearch;}
    window.location.href=url;
}

function deleteItem(id, item, value){
  if($("#delete"+id).hasClass("disabled")){return;}
	var r = confirm("Are you really sure you want to delete this "+item.slice(0, -1)+"?"); //remove s from plural string
	if (r !== true) {return false;} else{
		show("DELETING ITEM "+id+" call "+apiPath+"delete-item.php?id="+id+"&item="+item+"&value="+value);
		$.get(apiPath+"delete-item.php?id="+id+"&item="+item+"&value="+value, function() {})
		.done(function(){
      $("#tableRow"+id).remove();
		})
		.fail(function() { alert("We couldn't entry from the database. Please contact Elearn Australia on 0424 045 479.");});
	}
}

//====================================================================== UPLOAD //


function uploadFile(field,id){
	var files = document.getElementById(field).files; //read the files in the relevant file input
	show("UPLOAD FILE "+field+" "+id+" filename "+files[0].name);
	if(files.length > 0 ){//check there is file data
		var formData = new FormData();//create a form data object
    if (files[0].name.indexOf('"')!==-1||files[0].name.indexOf("'")!==-1){alert("Make sure the name of the file does not include any punctuation symbols."); return false;}
		formData.append("file", files[0]); //add the file to the file key in the form data object
		var xhttp = new XMLHttpRequest(); //set up AJAX request
		var xurl="upload-soundfile.php?dir="+language1; if(field==="image"){xurl="upload-imagefile.php?dir="+language1;} //set AJAX script according to media type
		xhttp.open("POST", xurl, true); //send AJAX request
		xhttp.onreadystatechange = function() { //success callback
			if (this.readyState == 4 && this.status == 200) {
				var response = this.responseText;
				if(response == 1){
					$("#"+field+"upload").addClass("uploaded").val("Uploaded");//change upload button to green
					$.get(apiPath+"set-data.php?id="+id+"&field="+field+"&table="+language1+"&value="+files[0].name, function() {})//write to db
          .done(function(){window.location.reload();});//reload page to show media players
				}else{
					alert("There was a problem uploading the file. Check that the file does not exceed 100kb.");
				}
			}
		};
		xhttp.send(formData); //pass form data object to request
	}else{
		alert("Please select a file"); //if no file in the file input
	}
}

function deleteFile(field,id,file){

	var r = confirm("Are you sure you want to delete this file?");
	if (r !== true) {return false;} else{
		var type="sound"; if(field==="image"){type="image";} //set variables according to media type
		show("DELETING FILE "+field+" "+id+" file "+file+" call "+apiPath+"deletefile.php?type="+type+"&file="+file);
		$.get(apiPath+"delete-file.php?type="+type+"&file="+file, function() {})
		.done(function(){
			$("#"+field+"Upload").css("display","table-cell"); $("#"+field+"Show").css("display","none");//show upload image options and hide image display
			$.get(apiPath+"set-data.php?id="+id+"&field="+field+"&table="+language1+"&value=", function() {});//write to db
			if (field==="soundfilename"){$.get(apiPath+"set-data.php?id="+id+"&field=speaker&table="+language1+"&value=", function() {});}//remove speaker if removing sound file
		})
		.fail(function() { alert("We couldn't delete the file from the database.");});
	}
}

//====================================================================== CONVERSATIONS //

function getConversations(){
	"use strict";
    console.log('getconversations '+apiPath+"get-conversations-text.php");
    $.getJSON(apiPath+"get-conversations-text.php?table="+language1, function(data) {if (data!==0) {console.log(JSON.stringify(data)); conversations=data; }})
  	.done(function() {
      //console.log("done getting conversations");
      $.getJSON(apiPath+"get-filters.php?table="+language1, function(data, conversations) {if (data!==0) {filters=data; }})
    	.done(function() {
        //console.log("done getting filters");
        if(conversations.length>0){
            var str="";
            for (var m=0;m<conversations.length; m++){
                for (var i=1; i<=6; i++){if (conversations[m]["entry"+i]===null){conversations[m]["entry"+i]="-";}}//replace null entries with
                var cid=0;
                cid = filters.findIndex(chunk=>chunk.translation===conversations[m].entry1);
                //get the first part's index in the chunkbank array
                //console.log("cid "+cid+" "+filters[cid].translation+" "+filters[cid].id+" ");
                str+='<div class="formrow">';
                str+='<div class="formcol5"><div class="formcontent">'+(m+1)+'</div></div>';
                str+='<div class="formcol15"><div class="formcontent">'+conversations[m].entry1+'</div></div>';
                str+='<div class="formcol15"><div class="formcontent">'+conversations[m].entry2+'</div></div>';
                str+='<div class="formcol15"><div class="formcontent">'+conversations[m].entry3+'</div></div>';
                str+='<div class="formcol15"><div class="formcontent">'+conversations[m].entry4+'</div></div>';
                str+='<div class="formcol15"><div class="formcontent">'+conversations[m].entry5+'</div></div>';
                str+='<div class="formcol15"><div class="formcontent">'+conversations[m].entry6+'</div></div>';
                str+='<div class="formcol5"><div class="formcontent"><button class="nostyle viewButton" onclick="viewShell('+filters[cid].id+',true);"><i class="fas fa-eye"></i></button> &nbsp; <a class="deleteLink" href="javascript:void(0)" onclick="deleteConversation('+conversations[m].id+');">X</a></div></div>';
                str+='</div>';
                //if (m===(conversations.length-1)){str+='<div class="clearBoth"></div>';}else{str+='<div class="clearBoth"><hr></div>';}
            }

            $("#conversationsList").html(str);
          }
      });
  	})
  	.fail(function() {});
}

function deleteConversation(m){
	"use strict";
    var r = confirm("Are you sure you want to delete this conversation?");
    if (r == true) {
        $.get(apiPath+"delete-conversation.php?m="+m+"&table="+language1, function() {})
            .done(function() {getConversations();})
            .fail(function() { });
    }
}




//====================================================================== FLAGS //

function toggleFlag(id){
    if ($(".flagIcon").hasClass("on")){
        $(".flagIcon").removeClass("on");
        $("#checkFlag").prop("checked", false);
    } else {
        $(".flagIcon").addClass("on");
        $("#checkFlag").prop("checked", true);
    }
    saveFlag(id);
}

function toggleIndexFlag(id){
    var flag="0";
    if ($("#flagIcon"+id).hasClass("disabled")){
        $("#flagIcon"+id).removeClass("disabled"); flag="1";
    } else {
        $("#flagIcon"+id).addClass("disabled");
    }
    writeFlag(id,flag);
}

function saveFlag(id){
    var flag="0";  if ($(".flagIcon").hasClass("on")){flag="1";}
    //show(apiPath+"set-data.php?id="+id+"&field=flag&value="+flag);
    writeFlag(id,flag);
}

function writeFlag(id,flag){
    //show("WRITE FLAG "+apiPath+"set-data.php?id="+id+"&field=flag&value="+flag);
    $.get(apiPath+"set-data.php?id="+id+"&field=flag&table="+language1+"&value="+flag, function() {})
	.done(function() {confirmSave(); })
	.fail(function() { });
}
function saveField(id,field,value){

    if(value.length>characterLimit){  errorSave("Character limit exceeded"); return; }//return and show error if character limit exceeded

    if($("body").attr("id")==="entries" || $("body").attr("id")==="edit"){
      //show("SAVE FIELD "+apiPath+"set-data.php?id="+id+"&field="+field+"&value="+value);
      $.get(apiPath+"set-data.php?id="+id+"&field="+field+"&table="+language1+"&value="+value, function() {})
  		.done(function() {
        confirmSave();})
  		.fail(function(error) {});
      //if they have changed something then set the flag to on for that entry
      //INDEX page
      if($("body").attr("id")==="entries"){
          $("#flagIcon"+id).removeClass("disabled");
      }
      //EDIT PAGE
      if($("body").attr("id")==="edit"){
          $(".flagIcon").addClass("on");
          $("#checkFlag").prop("checked", true);
      }
      writeFlag(id,"1");

    } else if($("body").attr("id")==="manage"){

      var item = $("#manageTable").data("field");//speakers, topics, heading

      //get previous value of textarea to replace these heading values in the topics table
      var replaceValue=""; if (item==="headings"){replaceValue=oldValue;} oldValue="";
      //SAVE FIELD https://elearnaustralia.com.au/opal/chinese/set-item.php?id=0&field=heading&value=Accommodations&item=headings&replace=Accommodation
      //show("SAVE FIELD "+apiPath+"set-item.php?id="+id+"&field="+field+"&value="+value+"&item="+item+"&replace="+replaceValue);
      $.get(apiPath+"set-item.php?id="+id+"&field="+field+"&table="+language1+"&value="+value+"&item="+item+"&replace="+replaceValue, function() {})
  		.done(function() {confirmSave(true);})
  		.fail(function() { });
    }
}

function writeCounters(){
    //number each table row
    var count=1; if ($("th").length>0){count=0;} //don't include headings in tr row count
    var table="entriesTable";
    if($("body").attr("id")==="manage"){table="manageTable";}
    $("#"+table+" tr").each(function() { //loop thru table rows
        if($(this).css("display")!=="none"){ //if we can see table row
            $("#"+$(this).attr("id")+" .rowcount").html(count); //write the row counter
            count++; //increment the count
        }
    });
    //$(".rowcount").each(function(i) { $(this).html(i+1);});
}

function confirmSave(id){
    if($("#save"+id).hasClass("disabled")){return;}
    $("#saving").fadeIn("slow",function(){$("#saving").delay(2000).fadeOut();})
}

function errorSave(msg){
    $("#errorMessage").html(msg);
    $("#error").fadeIn("slow",function(){$("#error").delay(2000).fadeOut();})
}

function addRow(id){
    //show("adding new row");
    //show("add row "+$("#add"+id).hasClass("disabled")+" id "+id);
    if ($("#add"+id).hasClass("disabled")===true){return false;}//don't do anything if add button is disabled

    if($("body").attr("id")==="entries"){ //for index page
    showQuick();
    //ENTRIES
    //insert empty row into db
    $.get(apiPath+"set-data.php?id=0&table="+language1, function(data) {
        //get id of new inserted row
        var lastRow=$.trim(data);
        //append table with new row
        var str='<tr id="tableRow'+lastRow+'" data-id="'+lastRow+'">';
        str+='<td class="col1"><div class="paddedText">';
        str+='<button class="nostyle addButton" id="add'+lastRow+'" onclick="addRow('+lastRow+');"><i class="fas fa-plus" data-id="'+lastRow+'"></i></button>';
        str+='<span class="rowcount"></span></div></td>';
        str+='<td class="col2"><div contenteditable="true" class="ta glossing" data-field="language" data-id="'+lastRow+'" id="language'+lastRow+'" onfocus="textAreaFocus(this);" onblur="textAreaBlur(this);" onclick="showQuick()"></div></td>';
        str+='<td class="col3"><div contenteditable="true" class="ta glossing" data-field="explanation'+'" data-id="'+lastRow+'" id="explanation'+lastRow+'" onfocus="textAreaFocus(this);" onblur="textAreaBlur(this);" onclick="showQuick()"></div></td>';
        str+='<td class="col4"><div contenteditable="true" class="ta glossing" data-field="translation" data-id="'+lastRow+'" id="translation'+lastRow+'" onfocus="textAreaFocus(this);" onblur="textAreaBlur(this);" onclick="showQuick()"></div></td>';
        str+='<td class="col5"><div class="paddedText">';
        //str+='<button class="nostyle saveButton" id="save'+lastRow+'" onclick="confirmSave('+lastRow+')"><i class="fas fa-save" data-id="'+lastRow+'"></i></button>';

        str+='<button class="nostyle" onclick="editEntry(\''+lastRow+'\');" title="Edit"><i class="fas fa-edit" data-id="'+lastRow+'"></i></button>';
        str+='<button class="nostyle" onclick="editConversations(\''+lastRow+'\');" title="Conversations"><i class="fas fa-comments" data-id="'+lastRow+'"></i></button>';
        str+='<button class="nostyle viewButton" id="view'+lastRow+'" onclick="viewShell('+lastRow+',false)" title="Preview in app"><i class="fas fa-eye" data-id="'+lastRow+'"></i></button>';
        str+='<button class="nostyle disabled" id="flagIcon'+lastRow+'" onclick="toggleIndexFlag('+lastRow+')" title="Toggle flag"><i class="fas fa-flag" data-id="'+lastRow+'"></i></button>';
        str+='<button class="nostyle" id="delete'+lastRow+'" onclick="deleteEntry(\''+lastRow+'\');" title="Delete"><i class="fas fa-trash-alt" data-id="'+lastRow+'"></i></button>';
        str+='</div></td>';
        str+='</tr>';
        if (id){
            //insert under table row
            //show("inserting new row under the selected row "+ id);
            $("#tableRow"+id).after(str);
            //$("#entriesTableBody").append(str);
        } else {
            //insert at end of table
            //show("inserting new row at end of table");
            $("#entriesTableBody").append(str);
        }
      })
        .done(function() {writeCounters();})
        .fail(function() {  });


      } else if($("body").attr("id")==="manage"){ //for manage page
    //MANAGE
    var item = $("#manageTable").data("field");
    show(item); if(item==="glossing"){return false;} //don't add new rows for managing glossing
    //insert empty row into db
    $.get(apiPath+"set-item.php?id=0&table="+language1+"&item="+item, function(data) {
        //get id of new inserted row
        var lastRow=$.trim(data);
        //append table with new row
        console.log("Last row"+lastRow);
        var str='<tr id="tableRow'+lastRow+'" data-id="'+lastRow+'">';
        str+='<td class="col1"><div class="paddedText">';
        str+='<span class="rowcount"></span></div></td>';

        if (item==="topics"){

          str+='<td class="col4"><select id="headingSelect'+lastRow+'" name="" class="" data-id="'+lastRow+'" data-selected="0">'+$("select").last().html()+'</select></td>';
          str+='<td class="col2"><div contenteditable="true" class="ta" data-field="topic" data-id="'+lastRow+'" id="topic'+lastRow+'" placeholder="Type here" onfocus="textAreaFocus(this);" onblur="textAreaBlur(this);"></div></td>';


        } else if (item==="speakers") {

          str+='<td class="col2"><div contenteditable="true" class="ta" data-field="name" data-id="'+lastRow+'" id="name'+lastRow+'" placeholder="Type here" onfocus="textAreaFocus(this);" onblur="textAreaBlur(this);"></div></td>';

        } else if (item==="functions") {

          str+='<td class="col2"><div contenteditable="true" class="ta" data-field="title" data-id="'+lastRow+'" id="title'+lastRow+'" placeholder="Type here" onfocus="textAreaFocus(this);" onblur="textAreaBlur(this);"></div></td>';

        }
         else if(item==="headings"){

          str+='<td class="col2"><div contenteditable="true" class="ta" data-field="heading" data-id="'+lastRow+'" id="heading'+lastRow+'" placeholder="Type here" onfocus="textAreaFocus(this);" onblur="textAreaBlur(this);"></div></td>';
        }



        str+='<td class="col3"><div class="paddedText">';
        str+='<button class="nostyle saveButton" id="save'+lastRow+'" onclick="confirmSave('+lastRow+')"><i class="fas fa-save" data-id="'+lastRow+'"></i></button>';
        str+='<button class="nostyle" onclick="deleteItem(\''+lastRow+'\',\''+item+'\');"><i class="fas fa-trash-alt" data-id="'+lastRow+'"></i></button>';
        str+='</div></td>';
        str+='</tr>';
        $("#manageTableBody").append(str);
      })
        .done(function() {writeCounters();  })
        .fail(function() {});
}


}

function setGlossing(str){
	"use strict";
	var newstr=""; var tag=""; var colour="";var startBracket=0; var lastDash=0; if(str===null){str="";}
	str=str.trim(); //e.g. dayi<col6> worlorr<col1> ga-<col2>nga-<col7>ma<col1> durdurla
    //check if chunk has been edited with editor - does it contain old mark up?
    var oldMarkUp=false;
    if (str.indexOf('<col')!==-1){ oldMarkUp=true;}
    if (oldMarkUp==false){
        //if there is no old mark up then don't do anything to the string
        newstr=str;
    } else {
        //if there is old mark up then reformat old mark up to HTML glossing
        var spacedChunks=str.split(" "); //start by separating string into chunks (by blank spaces)
        for (var a=0; a<spacedChunks.length; a++){//go through each of the chunks
            startBracket=spacedChunks[a].indexOf('<col');//check if chunk has glossing
            if (startBracket===-1){//chunk doesn't have any glossing
                newstr+=spacedChunks[a]+" ";
            } else{ //chunk has glossing
                //break chunk into array separated by >
                var subChunks=spacedChunks[a].split(">"); //sub chunks are glossed chunks within a spaced chunk (no blank space to separate them)
                for (var c=0; c<subChunks.length; c++){
                    if (subChunks[c].trim()!==""){//don't deal with empty chunks
                        startBracket=subChunks[c].indexOf('<col');
                        if (startBracket===-1){//chunk doesn't have any glossing
                            newstr+=subChunks[c];
                        } else{ //chunk has glossing
                            subChunks[c]+=">";
                            startBracket=subChunks[c].indexOf('<col');
                            tag=""; tag=subChunks[c].substring(startBracket,(subChunks[c].length-1)); //e.g. <col6>
                            colour=tag.substring(4,tag.length);//get colour
                            var glossString=removeGlossing(subChunks[c]);//remove the glossing from the core
                            lastDash=subChunks[c].lastIndexOf('-'); //see if there's a dash in the chunk
                            if (lastDash===startBracket-1){lastDash=-1;}//ignore the dash if it's right next to the chunk
                            if (lastDash!==-1){
                                //if there's a dash this means that the glossed word will start at the last dash not at the start of the array element
                                newstr+=glossString.substring(0,lastDash)+'<span class="colour'+colour+'">'+glossString.substr(lastDash)+'</span>';
                            } else {
                                newstr+='<span class="colour'+colour+'">'+glossString+'</span>';
                            }
                            //newstr+=subChunks[c]+'('+colour+") ";
                        }
                    }
                }
                newstr+=" "; //add space after array of spaced chunks
            }
        }
    }
	return newstr;
}

function removeGlossing(str){
	"use strict";
    if(str===null){str="";}
	str=str.replace(/<col[0-9]*>/g,'');
	return str;
}




function cleanUp(str){
    str = str.replace(/[^ -/(/)<>_*{}=:;@$%^&*.,?!'a-zA-Z0-9[u00E0-u00FF]]/g, '');
    str = str.replace(/["]/g, '\\"');
    str = str.replace(/<br>/g, '');
    str = str.replace(/#/g, '');
    str = str.replace(/&nbsp;/g, ' ');
    //str = str.replace(/&lt;br&gt;/g," ");
    str = str.replace(/[+]/g, '%2B'); //The plus is reserved in PHP so must be submitted to PHP as the encoded value: %2B
    return str;
}
